# Google Docs System Design
## 1. Тема и целевая аудитория
Google Документы – это текстовый редактор, позволяющий создавать и форматировать документы, а также работать над ними совместно с другими пользователями. 

### MVP
- Создать документ
- Изменять документ в реальном времени
- Работа с историей изменений
  - Просмотреть историю
  - Откатиться к прошлой версии
- Работа с ACL
  - Изменить права на просмотр/редактирование
  - Добавить/аннулировать ссылку на просмотр
- Клонировать документ

## Целевая аудитория
Уникальных пользователей в месяц: [500 млн](https://pro.similarweb.com/#/sales/account-review/traffic-engagement/docs.google.com/*/999/1m/?webSource=Total&selectedWidgetTab=UniqueUsers)

[Распределение по странам](https://pro.similarweb.com/#/sales/account-overview/docs.google.com/company)
- США: 27%
- Индия: 7,7%
- Индонезия: 6,5%
- Бразилия: 5,7%
- Япония: 3,3%

## 2. Расчет нагрузки
Google не предоставляет статистики по использованию сервиса Google Docs. Однако, есть [официальная квота на использование API](https://developers.google.com/docs/api/limits):
- Чтение
  - 3000 запросов на документ в минуту (всего)
  - 300 запросов на документ в минуту (от каждого пользователя)
- Запись
  - 600 запросов на документ в минуту (всего)
  - 60 запросов на документ в минуту (от каждого пользователя)

Исходя из официальной квоты:
- Документ читают в 5 раз чаще, чем редактируют
- Документ читают одновременно 10 ($3000 \over 300$) пользователей
- Документ редактируют одновременно 10 ($600 \over 60$) пользователей

Данных по использованию по времени Google не публикует, поэтому возьмем цифры с потолка:
- На просмотр документов пользователи тратят в среднем 60 минут в месяц  
  $$readingMinutesPerUser = 60$$
- На редактирование документа пользователи тратят в среднем 180 минут в месяц  
  $$editingMinutesPerUser = 180$$

Тогда
- Читающих пользователей: 500 млн в месяц (MAU) 
  $$readingUsers = 500 \cdot 10^6$$
- Редактирующих пользователей в месяц: 
$$editingUsers = {readingUsers \over 5} = 100 \cdot 10^6$$

Минут в одном месяце 
$$minutesInMonth = 60 \cdot 24 \cdot 30 = 49680 \sim 50 \cdot 10^3$$ 

В минуту читают одновременно: 
$$readsPerMinute = {readingMinutesPerUser\ \cdot\ readingUsers \over minutesInMonth} = {60 \cdot 500 \cdot 10^6 \over 50 \cdot 10^3} = 600 \cdot 10^3$$

В минуту редактируют одновременно: 
$$editsPerMinute = {editingMinutesPerUser\ \cdot\ editingUsers \over minutesInMonth} = {180 \cdot 100 \cdot 10^6 \over 50 \cdot 10^3} = 360 \cdot 10^3$$  

Исходя из квоты, в минуту пользователь может совершить 60 изменений в документе.
- Однако изменением может быть как изменение 1 символа, так и добавление картинки.  

Поэтому примем соглашение:
- Изменение - это добавление/изменение/удаление 1 байта в документе
- Примем, что 1 пользователь может совершить 100 изменений в документе в минуту
$$editsPerMinutePerUser = 100$$

Тогда кол-во запросов на изменение в минуту:
$$editsPerMinute \cdot editsPerMinutePerUser = 36 * 10^6$$

Объем данных, который придется сохранять за минуту, равен 36 МБ.

Если каждое изменение равно 1 байту, то входящий трафик в равен:
$$incomingMbitsPerMinute = 36 \cdot 10^6 \cdot 8 = 288 * 10^6 \sim 300 * 10^6\ Мбит/мин$$

Поскольку читателей в 5 раз больше, то исходящий трафик (чтение) равен
$$outgoingMbitsPerMinute = incomingMbitsPerMinute \cdot 5 = 1.5 * 10^9\ Мбит/мин$$